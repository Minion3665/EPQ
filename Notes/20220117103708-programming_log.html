<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Programming log</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" href="/simple.min.css" /><link rel="stylesheet" href="/custom.css" />
</head>
<body>
<div id="preamble" class="status">

<div class="header">
    <span class="title">Programming log</span>
    <div class="links">
        <a href="/">Home</a>
        <a href="/Notes/daily/2022-01-23.html">Latest daily</a>
        <a href="https://github.com/Minion3665/EPQ/issues/new">Report issue</a>
        <a href="https://github.com/Minion3665/EPQ">View source</a>
    </div>
</div>
</div>
<div id="content" class="content">
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org1845b3c">Layout</a></li>
<li><a href="#orgad53c4b">Building containers programatically</a>
<ul>
<li><a href="#orge74fb10">How did I solve it?</a></li>
<li><a href="#org072ef8a">What resources did I use?</a></li>
<li><a href="#orgd357704">How did this help me learn?</a></li>
</ul>
</li>
<li><a href="#orgd59c79d">Sleep command was overwritten by CNI</a>
<ul>
<li><a href="#org7d892f5">What was the problem?</a></li>
<li><a href="#org8d178cc">How did I solve it?</a></li>
<li><a href="#orga9afb01">What resources did I use?</a></li>
<li><a href="#org3a2cff3">How did this help me learn?</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org1845b3c" class="outline-2">
<h2 id="org1845b3c">Layout</h2>
<div class="outline-text-2" id="text-org1845b3c">
<ul class="org-ul">
<li>Each new problem will be under a heading, roughly in chronological order that I came across them (although problems that I anticipated and solved beforehand may be placed later, as it will be more logical and easier to read)</li>
<li>If there's a problem I believed I had solved but had not, I may list it multiple times, once when I initally solved it and subsequent times when I was forced to change and improve my solution. I will mention if this is the case</li>
<li>I'll rate each problem with a difficulty (1-5)</li>
<li>I'll explain how I solved each problem</li>
<li>I'll state how coming to this solution helped me to learn</li>
</ul>
</div>
</div>

<div id="outline-container-orgad53c4b" class="outline-2">
<h2 id="orgad53c4b">Building containers programatically</h2>
<div class="outline-text-2" id="text-orgad53c4b">
<ul class="org-ul">
<li>Difficulty: 2</li>
</ul>
</div>
<div id="outline-container-orge74fb10" class="outline-3">
<h3 id="orge74fb10">How did I solve it?</h3>
<div class="outline-text-3" id="text-orge74fb10">
<p>
<a href="https://github.com/ClicksMinutePer/process-manager/blob/097983953dc613702b9ea1a350496a0f90c4113e/containerManager/main.go#L80">This line</a> sets up the command that needs to be run in order to build the container
</p>
<div class="org-src-container">
<pre class="src src-go">cmd := exec.Command("nix-build", "./containerManager/config/"+id+"/"+version+".nix")
</pre>
</div>
<p>
and <a href="https://github.com/ClicksMinutePer/process-manager/blob/097983953dc613702b9ea1a350496a0f90c4113e/containerManager/main.go#L85">this line</a> runs the command
</p>
<div class="org-src-container">
<pre class="src src-go">err := cmd.Run()
</pre>
</div>
<p>
Inbetween I redirect the output and errors from the process to my terminal so I can see if there's any problems while it's building
</p>
<div class="org-src-container">
<pre class="src src-go">cmd.Stdout = os.Stdout
cmd.Stderr = os.Stderr
</pre>
</div>

<p>
I grabbed the default Nix config for docker containers, a container to say 'hello world' and built it using my script.
</p>
<div class="org-src-container">
<pre class="src src-nix">{ pkgs ? import &lt;nixpkgs&gt; { }
, pkgsLinux ? import &lt;nixpkgs&gt; { system = "x86_64-linux"; }
}:

pkgs.dockerTools.buildImage {
  name = "hello-docker";
  config = {
    Cmd = [ "${pkgsLinux.hello}/bin/hello" ];
  };
}
</pre>
</div>
<p>
Finally, I loaded the built file in docker and ran it
</p>
<div class="org-src-container">
<pre class="src src-bash">docker load &lt; result
docker start -t {<span style="font-weight: bold;">type</span>}
</pre>
</div>

<p>
This worked, and I got hello world in my console!
</p>
</div>
</div>
<div id="outline-container-org072ef8a" class="outline-3">
<h3 id="org072ef8a">What resources did I use?</h3>
<div class="outline-text-3" id="text-org072ef8a">
<p>
I used <a href="https://nixos.org/guides/building-and-running-docker-images.html">this nixos guide</a> and <a href="https://stackoverflow.com/a/31737077">this stackoverflow answer</a> to help me understand the Nix and go sides of running commands.
</p>
</div>
</div>
<div id="outline-container-orgd357704" class="outline-3">
<h3 id="orgd357704">How did this help me learn?</h3>
<div class="outline-text-3" id="text-orgd357704">
<p>
This taught me how to use Nix to build docker containers.
</p>
</div>
</div>
</div>

<div id="outline-container-orgd59c79d" class="outline-2">
<h2 id="orgd59c79d">Sleep command was overwritten by CNI</h2>
<div class="outline-text-2" id="text-orgd59c79d">
<ul class="org-ul">
<li>Difficulty 3</li>
</ul>
</div>
<div id="outline-container-org7d892f5" class="outline-3">
<h3 id="org7d892f5">What was the problem?</h3>
<div class="outline-text-3" id="text-org7d892f5">
<p>
This <i>wasn't</i> a problem with my EPQ, but rather was a problem with the impact it had on the rest of my system.
</p>

<p>
Linux has a command called <code>sleep</code>; it takes a number afterwards for how many seconds you need to sleep (for example <code>sleep 5</code> should sleep 5 seconds).(NO_ITEM_DATA:sleep_3)
</p>

<p>
Unfortunately, CNI also <a href="https://github.com/containernetworking/cni/blob/master/plugins/test/sleep/main.go">provides a sleep command</a>. The important thing to notice in that code is here: <code>time.Sleep(60 * time.Second)</code>. This means that the CNI sleep command will always sleep for 60 seconds, no matter what.
</p>

<p>
The CNI sleep command was running instead of the default sleep command when I ran sleep on my system, which meant that everything that needed to sleep for just a little bit was running really, really slowly.
</p>
</div>
</div>
<div id="outline-container-org8d178cc" class="outline-3">
<h3 id="org8d178cc">How did I solve it?</h3>
<div class="outline-text-3" id="text-org8d178cc">
<p>
As it's quite often that I need to find out what package a command comes from I decided to write a shell script to find out:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>
<span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"$1"</span> = <span style="font-style: italic;">""</span> ]
<span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">read</span> -ep <span style="font-style: italic;">"What command are you looking for?: "</span> CMD
<span style="font-weight: bold;">else</span>
  <span style="font-weight: bold; font-style: italic;">CMD</span>=$<span style="font-weight: bold; font-style: italic;">1</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;">LOCATION</span>=$(command -V <span style="font-style: italic;">"$CMD"</span> 2&gt;&amp;1 | sed -rn <span style="font-style: italic;">"s/.* (.*)$/\1/p"</span>)

<span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"$LOCATION"</span> = <span style="font-style: italic;">"found"</span> ] <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Not found</span>
<span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"The command $CMD wasn't found"</span>
  <span style="font-weight: bold;">exit</span> 1
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"$LOCATION"</span> = <span style="font-style: italic;">"builtin"</span> ] <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Shell builtin</span>
<span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"The command $CMD is a shell builtin"</span>
  <span style="font-weight: bold;">exit</span> 0
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;">RESOLVED_LOCATION</span>=$(readlink -f <span style="font-style: italic;">"$LOCATION"</span>)

<span style="font-weight: bold;">if</span> [[ ! <span style="font-style: italic;">"$RESOLVED_LOCATION"</span> =~ ^<span style="font-style: italic;">\/</span>nix<span style="font-style: italic;">\/</span>store<span style="font-style: italic;">\/</span>.*-.*-.*$ ]];
<span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"The command $CMD is at $RESOLVED_LOCATION"</span>
  <span style="font-weight: bold;">exit</span> 0
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;">PACKAGE</span>=$(<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"$RESOLVED_LOCATION"</span> | sed -rn <span style="font-style: italic;">"s/\/nix\/store\/.*-(.*)-.*/\1/p"</span>)

<span style="font-weight: bold; font-style: italic;">SEARCHED</span>=$(nix search <span style="font-style: italic;">"nixpkgs#$PACKAGE"</span> 2&gt;&amp;1)

<span style="font-weight: bold;">if</span> [ <span style="font-style: italic;">"$SEARCHED"</span> = <span style="font-style: italic;">"error: no results for the given search term(s)!"</span> ]
<span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"The command $CMD is at $RESOLVED_LOCATION"</span>
  <span style="font-weight: bold;">exit</span> 0
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"The command $CMD is from:"</span>
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"$SEARCHED"</span>
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Which is available at $RESOLVED_LOCATION"</span>
</pre>
</div>
<p>
This script takes a package name as input and tries to resolve it to a nix package; when I ran it for sleep it showed me that sleep was from the CNI package
</p>
<div class="org-src-container">
<pre class="src src-bash">{11:22}~ &#10157; bin/provider sleep
The command sleep is from:
<span style="font-style: italic;">\*</span> legacyPackages.x86_64-linux.cni (0.8.1)
  Container Network Interface - networking for Linux containers
Which is available at /nix/store/ps4v6qqayxhndmfj6pq6l4gqdglyz5pc-cni-0.8.1/bin/sleep
</pre>
</div>
<p>
I <a href="https://search.nixos.org/packages?channel=21.11&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=cni">searched for CNI on the nix package repo</a> and found that it was installed from <a href="https://github.com/containernetworking/cni">this github repo</a>. I searched the repo and found <a href="https://github.com/containernetworking/cni/blob/c5ab1c3fc6e164e7b777c3002e75fdf46865e1b3/plugins/test/sleep/main.go">this file</a>, which contains the broken code, confirming that it was definitely a broken sleep command from CNI.
</p>

<p>
To fix it I looked at what the CNI package did; was 'sleep' needed? I found that actually the main <code>containerd</code> package and the <code>cni-plugins</code> package actually have enough stuff to run the network for my EPQ as I was doing before. In the end the solution turned out to be as simple as just uninstalling the CNI package like so:
</p>
<div class="org-src-container">
<pre class="src src-diff"><span style="font-weight: bold;">diff --git a/system/containerd/systemPackages.nix b/system/containerd/systemPackages.nix</span>
<span style="font-weight: bold;">index 6a80afc..f7cd953 100644</span>
<span style="font-weight: bold;">--- </span><span style="font-weight: bold;">a/system/containerd/systemPackages.nix</span>
<span style="font-weight: bold;">+++ </span><span style="font-weight: bold;">b/system/containerd/systemPackages.nix</span>
<span style="font-weight: bold;">@@ -1,6 +1,5 @@</span>
 { pkgs, ... }: {
   systemPackages = with pkgs; [
-    cni
     cni-plugins
   ];
 }
</pre>
</div>
</div>
</div>
<div id="outline-container-orga9afb01" class="outline-3">
<h3 id="orga9afb01">What resources did I use?</h3>
<div class="outline-text-3" id="text-orga9afb01">
<ul class="org-ul">
<li>The sleep manual page</li>
<li>The source of the CNI package</li>
<li>The nix manual to figure out the <code>nix search</code> command</li>
<li>Various stackoverflow threads to help with writing a bash script</li>
</ul>
</div>
</div>
<div id="outline-container-org3a2cff3" class="outline-3">
<h3 id="org3a2cff3">How did this help me learn?</h3>
<div class="outline-text-3" id="text-org3a2cff3">
<ul class="org-ul">
<li>This helped me gain better familiarity with nix</li>
<li>This taught me to look at what packages I need better rather than installing anything vaguely related to CNI, say, and to install in a local scope unless I need a package globally</li>
</ul>
</div>
</div>
</div>
</div>
</body>
</html>
